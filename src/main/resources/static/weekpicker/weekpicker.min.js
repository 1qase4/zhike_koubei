/**
 * Created by Administrator on 2017/10/25.
 */
!function($){"use strict;";var Weekpicker=function(element,options){var that=this;this.element=$(element);this.isInput=this.element.is('input');this.currentYear=new Date().getFullYear();this.currentTime=/\u7b2c\d{2}\u5468\d{4}-[01]\d-[0123]\d/.test(this.element.val().trim())?this.element.val().trim():"";this.setEndDate=options.setEndDate&&typeof parseInt(options.setEndDate)==="number"?parseInt(options.setEndDate):new Date().getFullYear();this.pickerClass=options.eleClass;this.pickerId=options.eleId;this.isVisible=false;if(this.currentTime){this.currentYear=parseInt(this.currentTime.slice(4,8))}this._attachEvents();this.picker=$(template).appendTo('body').on({click:$.proxy(this.click,this),mousedown:$.proxy(this.mousedown,this)});$(document).on('mousedown',function(e){var target=$(e.target);if(target.closest(".wdateBox,.myWeek").length==0){that.hide()}});this.update();this.hide()};Weekpicker.prototype={constructor:Weekpicker,_events:[],_attachEvents:function(){this._detachEvents();this._events=[[this.element,{click:$.proxy(this.show,this)}]];for(var i=0,el,ev;i<this._events.length;i++){el=this._events[i][0];ev=this._events[i][1];el.on(ev)}},_detachEvents:function(){for(var i=0,el,ev;i<this._events.length;i++){el=this._events[i][0];ev=this._events[i][1];el.on(ev)}this._events=[]},show:function(e){this.picker.show();this.height=this.element.outerHeight();this.place();$(window).on('resize',$.proxy(this.place,this));if(e){e.stopPropagation();e.preventDefault()}this.isVisible=true},hide:function(e){this.picker.hide();$(window).off('resize',this.place);this.isVisible=false},place:function(){var index_highest=0;$('div').each(function(){var index_current=parseInt($(this).css("zIndex"),10);if(index_current>index_highest){index_highest=index_current}});var zIndex=index_highest+10;var offset,top,left;offset=this.element.offset();left=offset.left;top=offset.top+this.height;this.picker.css({top:top,left:left,zIndex:zIndex});if(this.pickerClass)this.picker.addClass(this.pickerClass);if(this.pickerId)this.picker.attr('id',this.pickerId)},click:function(e){e.stopPropagation();e.preventDefault();var target=$(e.target).closest('li,p');if(target.length==1){if(target.hasClass("lfArrow")){this.currentYear--;this.update()}else if(target.hasClass("rtArrow")){this.currentYear++;this.update()}else if(target.hasClass("week-item")){if(target.hasClass("active")){return false}target.addClass("active").siblings(".active").removeClass("active");this.currentTime=target.html();this.element.val(this.currentTime);this.element.trigger("change");this.hide()}}},update:function(){this.picker.find(".ywInput").val(this.currentYear);this.fill()},fill:function(){var firstDate=new Date(this.currentYear+"-01-01");var date=firstDate.getDate();var firstday=firstDate.getDay();date='0'+(firstday==0?date+1:firstday==1?date:date+(8-firstday));var firstD=new Date(this.currentYear+"-01-"+date);var html="<li class = 'week-item'>第01周"+this.currentYear+"-01-"+date+"</li>";if(this.currentTime=="第01周"+this.currentYear+"-01-"+date){html="<li class = 'week-item active'>第01周"+this.currentYear+"-01-"+date+"</li>"}var newDate;var i=1;while(true){newDate=this.getDateByPreNext(firstD,7);if(firstD.getFullYear()!=this.currentYear){break}var a=i+1;a=a<10?'0'+a:a;if(this.currentTime==="第"+a+"周"+newDate){html+="<li class = 'week-item active'>第"+a+"周"+newDate+"</li>"}else{html+="<li class = 'week-item'>第"+a+"周"+newDate+"</li>"}i++}this.picker.find(".weekInYear").empty().html(html);if(this.currentTime&&this.currentTime.indexOf(this.currentYear)>0){var height=this.picker.find("li").outerHeight();var n=parseInt(this.currentTime.slice(1,3));this.picker.find(".weekInYear").scrollTop((n-2)*height)}},getDateByPreNext:function(date,n){date.setDate(date.getDate()+n);var y=date.getFullYear();var m=date.getMonth()+1;m=m<10?'0'+m:m;var d=date.getDate();d=d<10?('0'+d):d;return y+"-"+m+"-"+d}};$.fn.weekpicker=function(option){return this.each(function(){var $this=$(this),options=typeof option=='object'&&option;new Weekpicker(this,options)})};$.fn.weekpicker.Constructor=Weekpicker;template="<div class='wdateBox'><div class='wdateTitle'><p class='lfArrow arrowImg'><i class='icon-arrow-left'></i></p><div class='wyearBox'><input type=text readonly class='ywInput'></div><p class='rtArrow arrowImg'><i class='icon-arrow-right'></i></p></div><ul class='weekInYear'></ul></div>";$.fn.weekpicker.template=template}(window.jQuery);